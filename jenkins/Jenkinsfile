pipeline {

  agent any


  environment {
    DEMO_PROJECT_HOME   =  "${env.WORKSPACE}"
    POSTGRES_BIN_DIR    = '/usr/pgsql-10/bin'
  }

  stages {

    stage('Build') {
      steps {
        sh './gradlew clean assemble'
        sh './gradlew flywayMigrate -i'
      }
    }

    stage('SonarQube analysis') {
      withSonarQubeEnv('SonarQube_primary') {
        // requires SonarQube Scanner for Gradle 2.1+
        // It's important to add --info because of SONARJNKNS-281
        sh './gradlew --info sonarqube'
      }
    }

    stage('Test') {
      steps {
        sh './gradlew test'
      }

      post {
        always {
          junit 'build/test-results/test/*.xml'
        }
      }

    }

  }

}
